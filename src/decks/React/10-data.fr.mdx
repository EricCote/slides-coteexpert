---
title: Données et Effets
description: other
---

# Données et Effets

---

## Qu'est-ce que useEffect

<img
  src='https://m.media-amazon.com/images/I/61vQ5HnKLdL._AC_UF894,1000_QL80_.jpg'
  alt='old phone'
  width='50%'
/>

`useEffect()` Hook React qui permet de synchroniser un composant avec un système externe.

---

## Qu'est-ce qu'un système externe?

Quelque chose qui n'est pas géré par React. React gère les composants, le JSX, le rendu et le résultat du rendu (virtual DOM)

React ne peut rien utiliser d'autre

- On ne peut utiliser une bibliothèque js (jQuery, Angular, GraphJS, etc)
- On ne peut faire de `fetch` réseau pour obtenir données
- APIs du navigateur (History API, Navigation API, Location API, etc)

Pourquoi? Le rendu doit être pur, sans effet de bord.

---

## Un effect roule après le rendu

Utiliser useEffect permet de créer un "Effect"

Les Effects sont exécutées immédiatement après le rendu (et après les fonctions de cleanup, s'il y a lieu)

<Alert type='danger'>
  **Attention:** Si un effect modifie l'état, ceci pourrait générer un rerendu,
  qui déclanche un autre effect, qui modifie l'état à nouveau... ainsi de
  suite... boucle infinie!
</Alert>
>

---

## Utilisation:

```js
useEffect(fn_Setup, dependencyArray?)
```

Paramètre fn_Setup:

- La fonction setup interagit et se connecte avec le monde externe
- Retourne une fonction flèche pour se déconnecter

Le tableau de dépendances détermine s'il faut exécuter

- un ou plusieurs changements: exécute l'Effet après le rendu
- aucun changement: pas d'exécution d'Effet
- Si le tableau est un tableau vide: l'Effet exécute au permier rendu seulement
- Si le tableau est `null` ou `undefined`: l'Effet exécute après chaque rendu

---

## useEffects n'est pas facile

- Rendu et useEffect exécutent deux fois en Dev (`<StrictMode/>`)
- Cela créé des rendu indésirables si on ne fait pas attention
- useEffect devrait affecter qu'un élément externe seulement, c'est plus complexe quand on affecte plusieurs choses.

<hr />

- Dependencies arrays are hard with strings, numbers and booleans
  - But they are even harder with objects or arrays
  - Comparison is done with referential equality (`Object.is()`)
  - You cannot detect when content has changed
  - Object and arrays need to be considered immutable

---

## The Goal

"With time, the React team’s goal is to reduce the number of the Effects in your app to the minimum by providing more specific solutions to more specific problems. "

[source](https://react.dev/learn/reusing-logic-with-custom-hooks#custom-hooks-help-you-migrate-to-better-patterns)

---

## Hash Routing

<Sandpack options={{ showNavigator: true }} >

```jsx src/App.js active
import { useEffect, useState } from 'react';
import Menu from './Menu';
import Route from './Route';

export default function App() {
  const [currentPage, setCurrentPage] = useState(window.location.hash);

  function changePage(evt) {
    setCurrentPage(window.location.hash);
  }

  useEffect(() => {
    //Handle the "hashchange" event
    window.addEventListener('hashchange', changePage);
    return () => window.removeEventListener('hashchange', changePage);
  }, []);

  return (
    <>
      <Menu />
      <Route page={currentPage} />
    </>
  );
}
```

```jsx src/Route.jsx
import Home from './Home';
import News from './News';
import Contact from './Contact';

export default function Route({ page }) {
  switch (page) {
    case '#home':
    case '#':
    case '':
      return <Home />;
    case '#news':
      return <News />;
    case '#contact':
      return <Contact />;
    default:
      return <div>404 error</div>;
  }
}
```

```jsx src/Menu.jsx
export default function Menu() {
  return (
    <ul className='menu'>
      {menuList.map((menuItem) => (
        <li key={menuItem.url}>
          <a
            className={menuItem.url === location.hash ? 'active' : ''}
            href={menuItem.url}
          >
            {menuItem.name}
          </a>
        </li>
      ))}
    </ul>
  );
}

const menuList = [
  {
    name: 'Home',
    url: '#',
  },
  {
    name: 'News',
    url: '#news',
  },
  {
    name: 'Contact',
    url: '#contact',
  },
  {
    name: 'About',
    url: '#about',
  },
];
```

```jsx src/Home.jsx
export default function Home() {
  return (
    <>
      <h1>Home page</h1>
      <p>This is the Home page!</p>
    </>
  );
}
```

```jsx src/News.jsx
export default function News() {
  return (
    <>
      <h1>News page</h1>
      <p>This is the News page!</p>
    </>
  );
}
```

```jsx src/Contact.jsx
export default function Contact() {
  return (
    <>
      <h1>Contact page</h1>
      <p>This is the contact page!</p>
    </>
  );
}
```

```css
ul.menu {
  list-style-type: none;
  margin: 0;
  margin-bottom: 1em;
  padding: 0;
  overflow: hidden;
  background-color: #333;
}

.menu li {
  float: left;
}

.menu li a {
  display: block;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

.menu li a:hover:not(.active) {
  background-color: #111;
}

.menu .active {
  background-color: royalblue;
}
```

</Sandpack>

---

## Hash Routing with useSyncExternalStore

<Sandpack options={{ showNavigator: true }} >

```jsx src/App.js active
import { useSyncExternalStore } from 'react';
import Menu from './Menu';
import Route from './Route';

// Function subscribing to external changes
// Similar to an effect subscription
function subscribeHashChange(onHashChange) {
  window.addEventListener('hashchange', onHashChange);
  return () => window.removeEventListener('hashchange', onHashChange);
}

export default function App() {
  const currentPage = useSyncExternalStore(
    subscribeHashChange, // subscribe to changes
    () => window.location.hash, // read the value (client)
    () => window?.location.hash // read the value (server)
  );

  return (
    <>
      <Menu />
      <Route page={currentPage} />
    </>
  );
}
```

```jsx src/Route.jsx
import Home from './Home';
import News from './News';
import Contact from './Contact';

export default function Route({ page }) {
  switch (page) {
    case '#home':
    case '#':
    case '':
      return <Home />;
    case '#news':
      return <News />;
    case '#contact':
      return <Contact />;
    default:
      return <div>404 error</div>;
  }
}
```

```jsx src/Menu.jsx
export default function Menu() {
  return (
    <ul className='menu'>
      {menuList.map((menuItem) => (
        <li key={menuItem.url}>
          <a
            className={menuItem.url === location.hash ? 'active' : ''}
            href={menuItem.url}
          >
            {menuItem.name}
          </a>
        </li>
      ))}
    </ul>
  );
}

const menuList = [
  {
    name: 'Home',
    url: '#',
  },
  {
    name: 'News',
    url: '#news',
  },
  {
    name: 'Contact',
    url: '#contact',
  },
  {
    name: 'About',
    url: '#about',
  },
];
```

```jsx src/Home.jsx
export default function Home() {
  return (
    <>
      <h1>Home page</h1>
      <p>This is the Home page!</p>
    </>
  );
}
```

```jsx src/News.jsx
export default function News() {
  return (
    <>
      <h1>News page</h1>
      <p>This is the News page!</p>
    </>
  );
}
```

```jsx src/Contact.jsx
export default function Contact() {
  return (
    <>
      <h1>Contact page</h1>
      <p>This is the contact page!</p>
    </>
  );
}
```

```css
ul.menu {
  list-style-type: none;
  margin: 0;
  margin-bottom: 1em;
  padding: 0;
  overflow: hidden;
  background-color: #333;
}

.menu li {
  float: left;
}

.menu li a {
  display: block;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

.menu li a:hover:not(.active) {
  background-color: #111;
}

.menu .active {
  background-color: royalblue;
}
```

</Sandpack>

---

## Hash Routing with a custom hook to wrap

<Sandpack options={{ showNavigator: true }} >

```jsx src/App.js active
import useHashChange from './useHashChange';
import Menu from './Menu';
import Route from './Route';

export default function App() {
  const currentPage = useHashChange();

  return (
    <>
      <Menu />
      <Route page={currentPage} />
    </>
  );
}
```

```jsx src/Route.jsx
import Home from './Home';
import News from './News';
import Contact from './Contact';

export default function Route({ page }) {
  switch (page) {
    case '#home':
    case '#':
    case '':
      return <Home />;
    case '#news':
      return <News />;
    case '#contact':
      return <Contact />;
    default:
      return <div>404 error</div>;
  }
}
```

```jsx src/useHashChange.jsx
import { useSyncExternalStore } from 'react';

function subscribeHashChange(onHashChange) {
  window.addEventListener('hashchange', onHashChange);
  return () => window.removeEventListener('hashchange', onHashChange);
}

export default function useHashChange() {
  return useSyncExternalStore(
    subscribeHashChange, // React won't resubscribe for as long as you pass the same function
    () => window.location.hash, // read value on client
    () => window?.location.hash // read value on the server
  );
}
```

```jsx src/Menu.jsx
export default function Menu() {
  return (
    <ul className='menu'>
      {menuList.map((menuItem) => (
        <li key={menuItem.url}>
          <a
            className={menuItem.url === location.hash ? 'active' : ''}
            href={menuItem.url}
          >
            {menuItem.name}
          </a>
        </li>
      ))}
    </ul>
  );
}

const menuList = [
  {
    name: 'Home',
    url: '#',
  },
  {
    name: 'News',
    url: '#news',
  },
  {
    name: 'Contact',
    url: '#contact',
  },
  {
    name: 'About',
    url: '#about',
  },
];
```

```jsx src/Home.jsx
export default function Home() {
  return (
    <>
      <h1>Home page</h1>
      <p>This is the Home page!</p>
    </>
  );
}
```

```jsx src/News.jsx
export default function News() {
  return (
    <>
      <h1>News page</h1>
      <p>This is the News page!</p>
    </>
  );
}
```

```jsx src/Contact.jsx
export default function Contact() {
  return (
    <>
      <h1>Contact page</h1>
      <p>This is the contact page!</p>
    </>
  );
}
```

```css
ul.menu {
  list-style-type: none;
  margin: 0;
  margin-bottom: 1em;
  padding: 0;
  overflow: hidden;
  background-color: #333;
}

.menu li {
  float: left;
}

.menu li a {
  display: block;
  color: white;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}

.menu li a:hover:not(.active) {
  background-color: #111;
}

.menu .active {
  background-color: royalblue;
}
```

</Sandpack>

---

## Near future

- The `use()` Hook can be used with any promise, to fetch data
- **Special:** does not need to be top Level like the other hooks.
- Can be used in loops, conditionals and inner functions
- Available in React 19

---

## Fetching with Effect

<Sandpack >

```jsx src/App.js active
import { useState, useEffect } from 'react';
import DisplayMovies from './DisplayMovies';

export default function App() {
  const [movies, setMovies] = useState([]);
  const [isLoading, setLoading] = useState(false);

  async function getMovies() {
    //get the data
    setLoading(true);
    const response = await fetch('https://mcuapi.herokuapp.com/api/v1/movies');
    const data = await response.json();

    //sort movies by release date
    const sortedMovies = data.data.toSorted(
      (a, b) =>
        new Date(a.release_date).valueOf() - new Date(b.release_date).valueOf()
    );

    setMovies(sortedMovies);
    setLoading(false);
  }

  useEffect(() => {
    getMovies();
  }, []);

  return (
    <>
      <h1>MCU Movies</h1>
      <button onClick={getMovies}>Refresh Movies</button>
      <DisplayMovies movies={movies} isLoading={isLoading} />
    </>
  );
}
```

```jsx src/DisplayMovies.jsx
export default function DisplayMovies({ movies, isLoading }) {
  if (isLoading) {
    return <div>Loading...</div>;
  }
  return movies.length > 0 ? (
    <div className='movieCards'>
      {movies.map((movie) => (
        <div key={movie.id}>
          <h3>{movie.title}</h3>
          <img src={movie.cover_url} />
          <p>
            <b>Release date: </b>
            {new Date(movie.release_date).toLocaleDateString()}
          </p>
          <p>{movie.overview}</p>
        </div>
      ))}
    </div>
  ) : (
    <div>No movies yet</div>
  );
}
```

```css
button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #d9d9d9;
  cursor: pointer;
  transition: border-color 0.25s;
  margin: 10px;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.movieCards {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;

  row-gap: 20px;
  column-gap: 20px;
  justify-content: space-between;
}

.movieCards > div {
  border-color: black;
  border-width: 1px;
  border-style: solid;
  border-radius: 20px;
  padding: 10px;
  width: 300px;
  flex-grow: 1;
  flex-shrink: 1;
}

.movieCards img {
  float: left;
  margin-right: 15px;
  width: 200px;
}
```

</Sandpack>

---

## Fetching with the future version of React

<Sandpack >

```jsx src/App.js active
import { use, Suspense } from 'react';
import DisplayMovies from './DisplayMovies';
import useRefresh from './useRefresh';

async function getMovies() {
  const response = await fetch('https://mcuapi.herokuapp.com/api/v1/movies');
  return response.json();
}

export default function App() {
  const refresh = useRefresh();

  return (
    <>
      <h1>MCU Movies</h1>
      <button onClick={refresh}>Refresh Movies</button>

      <Suspense fallback={<div>Loading...</div>}>
        <Movies />
      </Suspense>
    </>
  );
}

function Movies() {
  const rawData = use(getMovies());
  const movies = rawData.data.toSorted(
    (a, b) =>
      new Date(a.release_date).valueOf() - new Date(b.release_date).valueOf()
  );

  return <DisplayMovies movies={movies} />;
}
```

```jsx src/useRefresh.jsx
import { useState } from 'react';

export default function useRefresh() {
  const [, setRefresh] = useState();

  function refresh() {
    setRefresh({});
  }

  return refresh;
}
```

```jsx src/DisplayMovies.jsx
export default function DisplayMovies({ movies }) {
  return movies.length > 0 ? (
    <div className='movieCards'>
      {movies.map((movie) => (
        <div key={movie.id}>
          <h3>{movie.title}</h3>
          <img src={movie.cover_url} />
          <p>
            <b>Release date: </b>
            {new Date(movie.release_date).toLocaleDateString()}
          </p>
          <p>{movie.overview}</p>
        </div>
      ))}
    </div>
  ) : (
    <div>No movies yet</div>
  );
}
```

```json package.json
{
  "dependencies": {
    "react": "18.3.0-canary-ad720f36e-20240206",
    "react-dom": "18.3.0-canary-ad720f36e-20240206",
    "react-scripts": "latest"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test --env=jsdom",
    "eject": "react-scripts eject"
  }
}
```

```css
button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #d9d9d9;
  cursor: pointer;
  transition: border-color 0.25s;
  margin: 10px;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

.movieCards {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;

  row-gap: 20px;
  column-gap: 20px;
  justify-content: space-between;
}

.movieCards > div {
  border-color: black;
  border-width: 1px;
  border-style: solid;
  border-radius: 20px;
  padding: 10px;
  width: 300px;
  flex-grow: 1;
  flex-shrink: 1;
}

.movieCards img {
  float: left;
  margin-right: 15px;
  width: 200px;
}
```

</Sandpack>

---

## Questions?

<img
  src='/img/job.jpeg'
  style={{ marginLeft: 'auto', marginRight: 'auto', width: '50%' }}
/>

---

import Demo1 from './10-data/demo1.mdx';

<Demo1 components={props.components} />

---

import Demo2 from './10-data/demo2.mdx';

<Demo2 components={props.components} />

---

import Demo3 from './10-data/demo3.mdx';

<Demo3 components={props.components} />

---

import Demo4 from './10-data/demo4.mdx';

<Demo4 components={props.components} />

---

import Demo5 from './10-data/demo5.mdx';

<Demo5 components={props.components} />

---

## Calling an api

<Sandpack>

```js src/ContactApi.js
const base = 'https://contacts.reactacademy.live/api';

export default class ContactApi {
  static ws = null;

  static getAllContacts() {
    return fetch(`${base}/contacts`).then((resp) => resp.json());
  }

  static getContact(contactId) {
    return fetch(`${base}/contacts/${contactId}`).then((resp) => resp.json());
  }

  static saveContact(contact) {
    // Simulate server-side validation

    const minContactLength = 3;
    if (contact.firstName.length < minContactLength) {
      throw new Error(
        `First Name must be at least ${minContactLength} characters.`
      );
    }

    if (contact.lastName.length < minContactLength) {
      throw new Error(
        `Last Name must be at least ${minContactLength} characters.`
      );
    }

    if (contact.id) {
      //if id, update contact
      return fetch(`${base}/contacts/${contact.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(contact), // body data type must match "Content-Type" header
      });
    } else {
      //if no id, create contact
      return fetch(`${base}/contacts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(contact), // body data type must match "Content-Type" header
      }).then((resp) => resp.json());
    }
  }

  static deleteContact(contactId) {
    return fetch(`${base}/contacts/${contactId}`, { method: 'DELETE' });
  }

  static async registerNotification(fn) {
    if (this.ws === null) {
      // this.ws = {};
      const res = await fetch(`${base}/negotiate`);
      const url = await res.json();
      this.ws = new WebSocket(url.url);

      this.ws.onopen = () => console.log('connected');

      this.ws.onmessage = () => {
        fn();
      };
    }
  }

  static async unregisterNotification() {
    if (this.ws !== null) {
      this.ws.close();
      this.ws = null;
    }
  }
  static resetContacts() {
    return fetch(`${base}/contacts/reset`);
  }
}
```

```jsx src/App.js
import { useEffect, useState } from 'react';
import ContactApi from './ContactApi';
import ContactTable from './ContactTable';

export default function App() {
  const [contacts, setContacts] = useState([]);

  useEffect(() => {
    refreshData();
    // ContactApi.registerNotifications(refreshData);
    // return () => {
    //   ContactApi.unregisterNotifications();
    // };
  }, []);

  // This is the modern way of calling data (async)
  async function refreshData() {
    try {
      const data = await ContactApi.getAllContacts();
      setContacts(data);
    } catch (err) {
      console.log(err);
    }
  }

  async function modifyContact(formData) {
    const contact = Object.fromEntries(formData);
    if (contact.id === '0') contact.id = 0;
    if (contact.id === null) return;
    await ContactApi.saveContact(contact);
    await refreshData();
  }

  async function deleteContact(id) {
    await ContactApi.deleteContact(id);
    refreshData();
  }

  return (
    <>
      <h1>Contacts (using Hooks)</h1>
      <ContactTable
        contacts={contacts}
        modifyContact={modifyContact}
        deleteContact={deleteContact}
      />
    </>
  );
}

// to show a spinner while loading:
// { isLoading ? <Spinner /> : <ContactTable /> }
```

```jsx src/ContactTable.jsx
import { useState } from 'react';
//import { Table, Button, Form as F } from 'react-bootstrap';
//import { Link, Form } from 'react-router-dom';

function ContactTable({ contacts, modifyContact, deleteContact }) {
  const [modificationRow, setModificationRow] = useState(null);

  function modifyRow(id) {
    setModificationRow(id);
  }

  return (
    <form
      onSubmit={async (evt) => {
        evt.preventDefault();
        setModificationRow(null);
        modifyContact(new FormData(evt.currentTarget));
      }}
    >
      <table>
        <thead>
          <tr>
            <th style={{ maxWidth: 70 }}>id</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {contacts.map((contact) =>
            contact.id === modificationRow ? (
              <EditRow key={contact.id} contact={contact} setRow={modifyRow} />
            ) : (
              <Row
                key={contact.id}
                contact={contact}
                setRow={modifyRow}
                deleteContact={deleteContact}
              />
            )
          )}
        </tbody>
        <tfoot>
          {modificationRow === 0 ? (
            <EditRow
              contact={{ id: 0, firstName: '', lastName: '', email: '' }}
              setRow={modifyRow}
            />
          ) : (
            <tr>
              <td colSpan={5}>
                <button
                  title='Create Contact'
                  variant='primary'
                  onClick={() => {
                    setModificationRow(0);
                  }}
                >
                  ➕ Create Contact
                </button>
              </td>
            </tr>
          )}
        </tfoot>
      </table>
    </form>
  );
}

export default ContactTable;

function Row({ contact, setRow, deleteContact }) {
  return (
    <tr key={contact.id}>
      <td
        style={{
          maxWidth: 70,
          whiteSpace: 'nowrap',
          overflow: 'hidden',
          textOverflow: 'ellipsis',
        }}
        className='align-middle text-body-secondary text-truncate'
        title={contact.id.toString()}
      >
        {contact.id}
      </td>
      <td className='align-middle'>{contact.firstName}</td>
      <td className='align-middle'>{contact.lastName}</td>
      <td className='align-middle'>
        <a href={`mailto:{contact.email}`}>{contact.email}</a>
      </td>
      <td className='align-middle'>
        <button
          variant='primary'
          className='me-3'
          title='Edit'
          onClick={() => {
            setRow(contact.id);
          }}
        >
          🖊️
        </button>

        <button
          variant='secondary'
          className='me-3'
          title='Details'
          onClick={() => alert(`goto details for ${contact.firstName}`)}
        >
          🧾
        </button>

        <button
          title='Delete'
          variant='danger'
          onClick={() => deleteContact(contact.id)}
        >
          🗑️
        </button>
      </td>
    </tr>
  );
}

function EditRow({ contact, setRow }) {
  return (
    <tr key={contact.id} className='bg-warning'>
      <td
        style={{ maxWidth: 70 }}
        className='align-middle text-body-secondary text-truncate'
        title={contact.id.toString()}
      >
        <input name='id' placeholder='ID' defaultValue={contact.id} readOnly />
      </td>
      <td className='align-middle'>
        <input
          name='firstName'
          placeholder='First Name'
          defaultValue={contact.firstName}
        />
      </td>
      <td className='align-middle'>
        <input
          name='lastName'
          placeholder='Last Name'
          defaultValue={contact.lastName}
        />
      </td>
      <td className='align-middle'>
        <input
          name='email'
          placeholder='name@email.com'
          defaultValue={contact.email}
        />
      </td>
      <td className='align-middle'>
        <button variant='success' className='me-3' title='Save' type='submit'>
          ✔️
        </button>
        <button
          variant='warning'
          className='me-3'
          title='Cancel'
          onClick={() => {
            setRow(null);
          }}
        >
          ❌
        </button>
      </td>
    </tr>
  );
}
```

</Sandpack>
